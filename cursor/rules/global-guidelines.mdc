---
alwaysApply: true
---

# グローバル開発ガイドライン

このファイルは、すべてのプロジェクトに適用される基本的な開発方針とルールを定義します。

## 基本方針

- **常に日本語で応答する**
- グローバル設定を優先し、プロジェクト固有の設定は最小限にする
- 人間が読みやすく簡潔な設定を心がける

## Git運用

### コミットメッセージ

- 日本語で記述
- gitmoji を使用する
  - `:wrench:` 設定変更
  - `:bug:` バグ修正
  - `:sparkles:` 新機能
  - `:recycle:` リファクタリング
  - `:memo:` ドキュメント
  - `:white_check_mark:` テスト追加
  - `:art:` コードフォーマット

### ワークフロー

- ブランチ戦略はプロジェクトに従う
- コミット前にテスト実行（該当する場合）
- プルリクエストには詳細な説明を記載

## コーディング方針

### 設計原則

- **インターフェースに対してプログラミングする** - 具象クラスではなく抽象に依存
- **単一責任原則 (SRP)** - 1つのクラス/関数は1つの責任のみを持つ
- **DRY原則 (Don't Repeat Yourself)** - コードの重複を避け、再利用可能に設計
- 依存性注入を活用し、テスタビリティを確保

### コードスタイル

- 可読性を最優先
- コメントは日本語可
- 複雑なロジックには説明コメントを追加
- マジックナンバーは定数化
- ES modules (import/export) を優先
- 分割代入を積極的に使用

## テスト方針

### ⚠️ TDD (Test-Driven Development) を徹底する

**重要**: 新機能実装時は**必ずテストファースト**で進める

#### Red-Green-Refactor サイクルの厳守

1. **Red（失敗するテストを書く）**
   - 実装前に、期待する振る舞いを表すテストを書く
   - テストが失敗することを確認する（まだ実装していないため）

2. **Green（テストを通す最小限の実装）**
   - テストを通すために必要最小限のコードを書く
   - 綺麗さよりも「動く」ことを優先

3. **Refactor（コードを改善）**
   - テストが通った状態でコードを改善
   - DRY原則、設計原則を適用
   - テストが引き続き通ることを確認

#### 実装の流れ

**絶対にやらないこと**:
- ❌ テストなしで実装コードを書く
- ❌ 実装してから「後でテストを書く」
- ❌ 「簡単な機能だからテスト不要」と判断する

**必ずやること**:
- ✅ テストを先に書く（Red）
- ✅ 最小限の実装でテストを通す（Green）
- ✅ リファクタリングする（Refactor）
- ✅ テストがない既存コードに機能追加する場合は、まず既存機能のテストを書く

#### 例外

以下の場合のみテストファーストを省略可能:
- レガシーコードへの緊急バグ修正（ただし修正後すぐにテスト追加）
- プロトタイピング・概念実証（PoC）の段階
- UIの見た目調整のみの変更

### テストの粒度

- **ユニットテスト**: 個々の関数・クラスの振る舞いを検証（最優先）
- **統合テスト**: コンポーネント間の連携を検証
- **E2Eテスト**: ユーザーシナリオ全体を検証
- **テストカバレッジ**: 80%以上を目標（プロジェクトによる）

## セキュリティ

- 秘密情報をコミットしない
- .envファイルは必ず.gitignoreに追加
- APIキーやトークンはコードに直接書かない

## プロジェクト構造の把握

- まず README.md を確認する
- package.json、go.mod、Cargo.toml 等から技術スタックを把握
- ディレクトリ構造を ls や tree で確認
- `.cursor/rules/` ディレクトリでプロジェクト固有の情報を確認

## プロジェクト固有設定の優先順位

- プロジェクト固有の指示は、各リポジトリの `.cursor/rules/` ディレクトリ内のファイルを最優先とする。
- 参照順序（上から優先）:
  1) `./.cursor/rules/*.mdc`（プロジェクト固有）
  2) `./.cursorrules`（プロジェクトルート）
  3) Cursor のデフォルト設定

> グローバル方針は本ファイルに記載し、プロジェクト特有のルールやコマンドは `.cursor/rules/` ディレクトリ内に明示すること。

## よく使うBashコマンド

```bash
ls -la                  # ファイル一覧を詳細表示
git status              # Gitの状態確認
git log --oneline -10   # 最近のコミット履歴
cat README.md           # READMEを確認
```

## コードレビュー方針

コードレビューは、コードの品質を担保し、チーム全体の知識を共有するための重要なプロセスです。以下の観点を中心に確認します。

**レビューの優先順位**: セキュリティ > 堅牢性 > 設計 > パフォーマンス > 可読性

> **Note**: 言語・フレームワーク固有の詳細なレビュー基準は、各プロジェクトの `.cursor/rules/` ディレクトリ内に記載してください。

### 1. 設計と責務

-   **設計原則の遵守**: 「コーディング方針」で定義された原則（SRP, DRY, インターフェースへの依存など）が守られているか。
-   **責務の分離**: クラスや関数の責務は単一か。凝集度は高く、結合度は低く保たれているか。
-   **拡張性**: 将来の仕様変更に対して、容易に拡張できる設計になっているか。

### 2. 堅牢性と回復力 (Robustness)

-   **エラー処理**:
    -   `null` や未定義値、空のデータ構造に対する考慮は十分か。
    -   予期せぬエラーが発生した場合、プログラムがクラッシュせず、適切にエラーをハンドリング（ログ出力、フォールバック処理など）できるか。
-   **リトライ処理**:
    -   外部API呼び出しなどでリトライを実装する場合、**冪等性（何度実行しても結果が同じであること）**は保証されているか。
    -   リトライのループに入る前に、関連する状態が適切にリセットされているか。
-   **リソース管理**:
    -   データベース接続、ファイルハンドル、ネットワーク接続などが、`try-finally` ブロックや言語の持つクリーンアップ機構（例: Pythonの `with` 文）を用いて確実に解放されているか。リソースリークの懸念はないか。
-   **タイムアウト管理**:
    -   外部システムへのリクエストや、時間のかかる可能性のある処理には、適切なタイムアウトが設定されているか。無限待機に陥る可能性を排除できているか。

### 3. テストの網羅性

-   **テストケースの観点**:
    -   **正常系**: 想定通りの入力で正しく動作するか。（ハッピーパス）
    -   **準正常系**: 境界値、`null`、空文字、ゼロなど、仕様上許容されるエッジケースが網羅されているか。
    -   **異常系**: 想定外の入力、外部システムの障害、不正な状態などで、システムが安全に失敗（フェイルセーフ）するか。
-   **テストの品質**: テストコード自体の可読性や保守性は高いか。テストのためのテストになっていないか。

### 4. パフォーマンスと効率

-   非効率なループ処理（ネストが深すぎるなど）や、一度の操作で大量のデータベースクエリを発行するような処理（N+1問題など）は存在しないか。
-   大量データを扱う場合、メモリ使用量や計算量は考慮されているか。

### 5. セキュリティ

-   SQLインジェクションやクロスサイトスクリプティング（XSS）など、典型的な脆弱性が作り込まれていないか。
-   認証・認可のロジックは適切か。アクセス制御に漏れはないか。

### 6. その他（可読性と保守性）

-   **命名**: 変数名、関数名、クラス名がその役割を的確に表しているか。
-   **コメント**: なぜその実装にしたのかという「意図」が、複雑なロジックや直感的でないコードにコメントとして残されているか。
-   **ドキュメント**: ユーザーに影響のある変更や、重要なアーキテクチャの変更があった場合、READMEなどの関連ドキュメントも更新されているか。

## その他

- READMEは常に最新に保つ
- 破壊的変更は明示的に文書化
- 設定は会話中に `.cursor/rules/` ディレクトリ内のファイルで追加・改善していく

## アーキテクチャ指針（一般・UI非依存）

本プロジェクトの基本方針（Repository / UseCase / DI）は UI 技術に依存しません。目的は以下です。
- UI とデータ操作を分離しテスト容易性・保守性を向上
- 保存先（ファイル/DB/HTTP/メモリ）の差し替えを可能に
- 日付付与・検証・整形などのアプリ手続きを UseCase に集約

### レイヤ構成（依存方向）
- Presentation（UI/CLI/API Handler 等）
  - ↓ Application（UseCase）
    - ↓ Domain（Repository 抽象/エンティティ/バリュー）
      - ↓ Infrastructure（Repository 具体実装: DB/HTTP/FS/Memory 等）

依存は常に上から下の一方向。Presentation は具体実装を知らず、抽象（インターフェイス）越しにやり取りします。

### 典型ディレクトリ構造（例）
```
app/
  presentation/
  application/
    usecase/
  domain/
    ranking/
      entity.ts
      repository.ts
  infrastructure/
    ranking/
      memory/
      file/
      http/
  shared/
    clock.ts
  main.ts
```

### 主要インターフェイス例（概念）
- Domain の `Repository` は永続化境界を抽象化し、UseCase はアプリ手続きを薄く表現します。
- Composition Root（起動点）で具体実装と依存（Clock 等）を生成・注入します。

### テスト戦略
1) Contract Test: Repository 抽象に対し InMemory/実装が同一振る舞いか検証
2) UseCase Test: Clock を固定し、副作用（日時付与/整形）を検証
3) Presentation Test: Handler/CLI/画面が UseCase 結果を正しく描画/返却

### 注意点
- エラーは層境界で適切に変換
- ロギング/メトリクスは UseCase 境界へ集約

## 言語・フレームワーク別ガイドライン

以下の言語・フレームワーク固有のガイドラインも参照してください：

- [React プロジェクトガイドライン](./react-guidelines.mdc)
- [Go プロジェクトガイドライン](./go-guidelines.mdc)
- [Terraform プロジェクトガイドライン](./terraform-guidelines.mdc)
- [TypeScript プロジェクトガイドライン](./typescript-guidelines.mdc)

---

*参考: [Cursor Rules Documentation](https://docs.cursor.com/ja/context/rules), [Cursor Best Practices](https://docs.cursor.com/ja/)*