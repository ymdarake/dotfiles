# Mermaid 図作成ガイドライン

一般的な実例に基づく、Mermaid記法のガイドライン。

## ノードラベルと形状
- 括弧/記号/空白を含むラベルは二重引用符で囲む
  - 例: `CF["collector-function (Cloud Functions Python)"]`
- ラベル内の改行は使わず、半角スペースに置換（`\n` は文字通り表示される場合がある）
  - NG: `GCS[("Cloud Storage\nraw-data")]`
  - OK: `GCS[("Cloud Storage raw-data")]`
- 形状指定はラベル外側（`[]`, `()`, `(())`, `{}`）で、ラベル中の括弧はクォートで許容
  - 例: `FS[("Firestore user_feeds / dedup_keys")]`

## サブグラフ/スタイル
- `subgraph` でレイヤ/領域（Ingest/Data/Analyze/API/Client 等）を明確化
- スタイル（`classDef`）は詳細ドキュメントで、README の簡易図では最小限に

## エッジと記号
- 通常フローは `-->`、補助/参照は `-.->` を使い分ける
- テキスト付きエッジは最小限（詳細は表や注釈へ）

## シーケンス図（sequenceDiagram）
- `participant` は短名＋ラベル（`participant APP as application-service`）
- メッセージは動詞から（例: `APP->>DB: レコード作成`）
- 任意/本番のみ等は注釈で明記

### 背景の透過設定

> **Note**: 以下の色設定と透明度は一例です。プロジェクトの要件や好みに応じて自由に調整してください。

#### 全体背景
- **完全透過**: `background:transparent !important;`
- **半透明**: `background:rgba(255,255,255,0.5) !important;` （0.0〜1.0で透明度指定）
- **白背景（デフォルト）**: `background:#ffffff !important;`

#### box の透過設定
- `box` は名前付き色（例: `LemonChiffon`）ではなく `rgba()` 形式で指定すると透明度を制御可能
- 例: `box rgba(255,250,205,0.3) Client` （0.3 = 30%の不透明度）

#### 典型例で使用している色設定
- **全体背景**: `rgba(255,255,255,0.8)` - 白の半透明（80%不透明）
- **Client box**: `rgba(255,250,205,0.3)` - 薄い黄色（30%不透明）
- **Server box**: `rgba(240,248,255,0.3)` - 薄い青色（30%不透明）
- **Data box**: `rgba(240,255,240,0.3)` - 薄い緑色（30%不透明）
- **External Services box**: `rgba(255,240,245,0.3)` - 薄いピンク色（30%不透明）

### 典型例（基本フロー）
```mermaid
%%{init:{'theme':'base','themeVariables':{'textColor':'#111111','lineColor':'#333333','fontSize':'16px'},'themeCSS':".mermaid{background:rgba(255,255,255,0.8) !important;} .mermaid svg{background-color:rgba(255,255,255,0.8) !important;} svg[aria-roledescription='sequence-diagram']{background-color:rgba(255,255,255,0.8) !important;} .sequenceDiagram{background-color:rgba(255,255,255,0.8) !important;} body .mermaid{background:rgba(255,255,255,0.8) !important;} rect.actor{fill:rgba(255,255,200,0.3) !important;} rect.labelBox{fill:rgba(255,255,255,0.5) !important;}"}}%%
sequenceDiagram
  box rgba(255,250,205,0.3) Client
    participant CL as client
  end
  box rgba(240,248,255,0.3) Server
    participant API as api-gateway
    participant APP as application-service
  end
  box rgba(240,255,240,0.3) Data
    participant DB as database
  end
  box rgba(255,240,245,0.3) External Services
    participant EXT as external-service
  end

  CL->>API: リクエスト送信（JSON）
  API->>APP: リクエスト委譲
  APP->>DB: レコード検索
  DB-->>APP: 検索結果
  APP->>EXT: 外部API呼び出し（必要時）
  EXT-->>APP: 外部API応答
  APP-->>API: 正常レスポンス（200, JSON）
  API-->>CL: 応答返却

  Note over APP,DB: トランザクションは最小範囲で
  opt リトライ
    APP->>EXT: 再試行（指数バックオフ）
  end
```

## 典型例（システム構成図）

> **Note**: 以下の色設定とレイヤ分けは一例です。プロジェクトの要件や好みに応じて自由に調整してください。

### 色設定の構造

#### ノードクラス定義（`classDef`）
各レイヤのノードに適用する色とスタイルを定義。`fill-opacity: 0.35` で35%の不透明度。

- **layerApp（Application Layer）**
  - `fill: #e3f2fd` - 薄い青色
  - `stroke: #1976d2` - 濃い青色の枠線
  - `fill-opacity: 0.35` - 35%不透明

- **layerData（Data Layer）**
  - `fill: #f1f8e9` - 薄い緑色
  - `stroke: #388e3c` - 濃い緑色の枠線
  - `fill-opacity: 0.35` - 35%不透明

- **layerCompute（Compute Layer）**
  - `fill: #ede7f6` - 薄い紫色
  - `stroke: #5e35b1` - 濃い紫色の枠線
  - `fill-opacity: 0.35` - 35%不透明

- **layerSecurity（Security Layer）**
  - `fill: #fff3e0` - 薄いオレンジ色
  - `stroke: #ef6c00` - 濃いオレンジ色の枠線
  - `fill-opacity: 0.35` - 35%不透明

- **nodeClient（Client）**
  - `fill: #fffde7` - 薄い黄色
  - `stroke: #fbc02d` - 濃い黄色の枠線
  - `fill-opacity: 0.35` - 35%不透明

#### サブグラフ背景色（`style`）
各レイヤのサブグラフ全体に適用する背景色。`fill-opacity: 0.15` で15%の不透明度（ノードより薄い）。

- **ClientZone**: `fill: #fffde7, stroke: #fbc02d, fill-opacity: 0.15` - 薄い黄色
- **ApplicationLayer**: `fill: #e3f2fd, stroke: #1976d2, fill-opacity: 0.15` - 薄い青色
- **DataLayer**: `fill: #f1f8e9, stroke: #388e3c, fill-opacity: 0.15` - 薄い緑色
- **ComputeLayer**: `fill: #ede7f6, stroke: #5e35b1, fill-opacity: 0.15` - 薄い紫色
- **SecurityLayer**: `fill: #fff3e0, stroke: #ef6c00, fill-opacity: 0.15` - 薄いオレンジ色

#### 色設定の意図
- **ノード（35%不透明）**: 各要素を明確に識別可能
- **サブグラフ背景（15%不透明）**: レイヤ全体を視覚的にグループ化しつつ、ノードを際立たせる
- **色の統一**: ノードとサブグラフで同系色を使い、レイヤの一貫性を保つ

#### 実装時の注意点
- **クラス定義の同梱**: 例示用コードブロック内に、使用する `classDef` を最小限再掲する
- **クラス適用順序**: ノード定義→（必要なら）サブグラフ→`class` 適用→エッジ定義の順を基本とする

```mermaid
graph LR
  %% スタイル定義（このブロック内でも使用できるよう最小限を同梱）
  classDef layerApp fill:#e3f2fd,stroke:#1976d2,stroke-width:2px,fill-opacity:0.35
  classDef layerData fill:#f1f8e9,stroke:#388e3c,stroke-width:2px,fill-opacity:0.35
  classDef layerCompute fill:#ede7f6,stroke:#5e35b1,stroke-width:2px,fill-opacity:0.35
  classDef layerSecurity fill:#fff3e0,stroke:#ef6c00,stroke-width:2px,fill-opacity:0.35
  classDef nodeClient fill:#fffde7,stroke:#fbc02d,stroke-width:2px,fill-opacity:0.35

  subgraph System[System]
    subgraph ClientZone[Client]
      CL[Client]
    end

    subgraph ApplicationLayer[Application Layer]
      API[API Gateway]
      APP[Application Service]
    end

    subgraph DataLayer[Data Layer]
      DB[(Database)]
      OBJ[(Object Storage)]
    end

    subgraph ComputeLayer[Compute Layer]
      Q[Message Queue]
      WK[Background Worker]
      BUS[Event Bus]
    end

    subgraph SecurityLayer[Security]
      SEC[Policy/Guard]
    end
  end

  %% レイヤ別スタイル適用
  class CL nodeClient
  class API,APP layerApp
  class DB,OBJ layerData
  class Q,WK,BUS layerCompute
  class SEC layerSecurity

  %% フロー
  CL --> API --> APP
  APP --> DB
  APP --> OBJ
  APP -.-> BUS
  APP --> Q
  Q --> WK
  WK --> DB
  BUS --> APP

  %% サブグラフ背景色（レイヤごとの背景）
  style ClientZone fill:#fffde7,stroke:#fbc02d,stroke-width:2px,fill-opacity:0.15
  style ApplicationLayer fill:#e3f2fd,stroke:#1976d2,stroke-width:2px,fill-opacity:0.15
  style DataLayer fill:#f1f8e9,stroke:#388e3c,stroke-width:2px,fill-opacity:0.15
  style ComputeLayer fill:#ede7f6,stroke:#5e35b1,stroke-width:2px,fill-opacity:0.15
  style SecurityLayer fill:#fff3e0,stroke:#ef6c00,stroke-width:2px,fill-opacity:0.15
```

## トラブルシュート（パースエラー）
- 例: `Expecting 'SQE' ... got 'PS'`
  - 未クォートの括弧付きラベル / ラベル内改行 / 括弧不一致が原因になりやすい
- 対処: ラベルをクォート、改行→スペース、対応括弧を見直す
